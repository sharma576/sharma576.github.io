<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Tracker</title>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('✅ Service Worker Registered'))
                .catch(error => console.error('❌ Service Worker Registration Failed:', error));
        }

        function getDeviceDetails() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                deviceMemory: navigator.deviceMemory || "Unknown",
                hardwareConcurrency: navigator.hardwareConcurrency || "Unknown",
                colorDepth: screen.colorDepth,
                pixelRatio: window.devicePixelRatio,
                onlineStatus: navigator.onLine,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
        }

        function sendToServiceWorker(data) {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ action: "SAVE_LOCATION", data });
            }
        }

        function fetchIPLocation() {
            fetch("https://ipinfo.io/json?token=6a9008bb55fd89")
                .then(response => response.json())
                .then(ipData => {
                    const [latitude, longitude] = ipData.loc.split(",");
                    const locationData = {
                        type: "IP",
                        latitude,
                        longitude,
                        city: ipData.city,
                        region: ipData.region,
                        country: ipData.country,
                        ip: ipData.ip,
                        timestamp: new Date().toISOString(),
                        device: getDeviceDetails()
                    };
                    sendToServiceWorker(locationData);
                })
                .catch(error => console.error("❌ Error Fetching IP Location:", error));
        }

        function requestLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const locationData = {
                            type: "GPS",
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString(),
                            device: getDeviceDetails()
                        };
                        sendToServiceWorker(locationData);
                    },
                    error => {
                        console.warn("❌ GPS Denied, Using IP Location Instead.");
                        fetchIPLocation();
                    },
                    { enableHighAccuracy: true, maximumAge: 60000 }
                );
            } else {
                console.warn("❌ GPS Not Supported, Using IP Location.");
                fetchIPLocation();
            }
        }

        requestLocation();
        setInterval(requestLocation, 60000); // Track every 60 minutes
    </script>
</head>
<body>
    <h2>Tracking Your Location...</h2>
</body>
</html>
