<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Tracker</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAB6STYBF-Fzg4U4QkET_bMej47ZUJDM4Y",
            authDomain: "locationsaver-b9997.firebaseapp.com",
            projectId: "locationsaver-b9997",
            storageBucket: "locationsaver-b9997.firebasestorage.app",
            messagingSenderId: "675975845355",
            appId: "1:675975845355:web:95cf7d6a2c255a33be35ae",
            measurementId: "G-WJJY3Q2M8E"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Get IST Time
        function getISTTime() {
            let now = new Date();
            let istOffset = 5.5 * 60 * 60 * 1000; // IST is UTC+5:30
            let istTime = new Date(now.getTime() + istOffset).toISOString();
            return istTime;
        }

        // Generate a Unique Cache ID
        function generateCacheID() {
            return 'cache-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }

        // Get Device Info
        function getDeviceInfo() {
            const userAgent = navigator.userAgent;
            let deviceType = /Mobi|Android/i.test(userAgent) ? "Mobile" : "Desktop";

            let browser = "Unknown";
            if (userAgent.indexOf("Chrome") > -1) {
                browser = "Chrome";
            } else if (userAgent.indexOf("Firefox") > -1) {
                browser = "Firefox";
            } else if (userAgent.indexOf("Safari") > -1) {
                browser = "Safari";
            } else if (userAgent.indexOf("Edge") > -1) {
                browser = "Edge";
            } else if (userAgent.indexOf("Opera") > -1) {
                browser = "Opera";
            }

            let os = "Unknown";
            if (userAgent.indexOf("Win") > -1) {
                os = "Windows";
            } else if (userAgent.indexOf("Mac") > -1) {
                os = "MacOS";
            } else if (userAgent.indexOf("Linux") > -1) {
                os = "Linux";
            } else if (userAgent.indexOf("Android") > -1) {
                os = "Android";
            } else if (userAgent.indexOf("iOS") > -1) {
                os = "iOS";
            }

            return { deviceType, browser, os };
        }

        // Save Data to Firestore
        async function saveUserData(data) {
            try {
                await addDoc(collection(db, "user_data"), data);
                console.log("‚úÖ Data saved:", data);
                saveToCache(data);
            } catch (error) {
                console.error("‚ùå Error saving data:", error);
                saveToCache(data);
            }
        }

        // Save Data to Cache Storage
        async function saveToCache(data) {
            if ('caches' in window) {
                const cache = await caches.open('location-cache-v1');
                await cache.put(data.cacheID, new Response(JSON.stringify(data), { headers: { "Content-Type": "application/json" } }));
                console.log("üìÅ Data stored in cache:", data.cacheID);
            }
        }

        // Get GPS Location
        function getGPSLocation(callback) {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(position => {
                    let deviceInfo = getDeviceInfo();
                    let data = {
                        cacheID: generateCacheID(),
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        time: getISTTime(),
                        source: "GPS",
                        deviceType: deviceInfo.deviceType,
                        browser: deviceInfo.browser,
                        os: deviceInfo.os
                    };
                    callback(data);
                }, () => {
                    console.warn("‚ùå GPS Denied! Using IP Location.");
                    getIPLocation(callback);
                });
            } else {
                console.warn("‚ùå GPS not supported.");
                getIPLocation(callback);
            }
        }

        // Get IP Location (Fallback)
        function getIPLocation(callback) {
            fetch("https://ipinfo.io/json?token=6a9008bb55fd89")
                .then(response => response.json())
                .then(data => {
                    let deviceInfo = getDeviceInfo();
                    let location = {
                        cacheID: generateCacheID(),
                        ip: data.ip,
                        city: data.city,
                        region: data.region,
                        country: data.country,
                        latitude: data.loc.split(",")[0],
                        longitude: data.loc.split(",")[1],
                        time: getISTTime(),
                        source: "IP",
                        deviceType: deviceInfo.deviceType,
                        browser: deviceInfo.browser,
                        os: deviceInfo.os
                    };
                    callback(location);
                })
                .catch(error => {
                    console.error("‚ùå Error fetching IP location:", error);
                    callback(null);
                });
        }

        // Periodic Tracking (Every 60 Minutes)
        function startTracking() {
            getGPSLocation(location => {
                if (location) {
                    saveUserData(location);
                }
            });

            setInterval(() => {
                getGPSLocation(location => {
                    if (location) {
                        saveUserData(location);
                    }
                });
            }, 60 * 60 * 1000); // Every 60 minutes
        }

        // Register Service Worker for Background Sync
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("sw.js").then(reg => {
                console.log("‚úÖ Service Worker Registered");
            }).catch(error => {
                console.error("‚ùå Service Worker Registration Failed:", error);
            });
        }

        // Start Tracking When Page Loads
        startTracking();
    </script>
</head>

<body>
    <h1>Tracking Location...</h1>
    <p>This page is tracking your location every 60 minutes.</p>
</body>
</html>
